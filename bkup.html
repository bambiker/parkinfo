<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>×’×™×‘×•×™ ×ª××•× ×•×ª ××”×—× ×™×•× ×™×</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
  <h1>ğŸ“¦ ×™×¦×™×¨×ª ZIP ×œ×ª××•× ×•×ª</h1>
  <button onclick="loadAndZip()">ğŸ“¥ ×¦×•×¨ ×•×”×•×¨×“ ZIP ×©×œ ×›×œ ×”×ª××•× ×•×ª</button>
  <div id="status" style="margin-top: 1em; white-space: pre-line;"></div>

  <script>
    async function loadAndZip() {
      const statusDiv = document.getElementById('status');
      statusDiv.innerText = "ğŸ“¡ ×˜×•×¢×Ÿ ××ª ×”× ×ª×•× ×™×...";

      try {
        const response = await fetch('marker.json');
        if (!response.ok) throw new Error('×©×’×™××” ×‘×˜×¢×™× ×ª marker.json');
        const markerData = await response.json();

        const zip = new JSZip();
        let successCount = 0;
        let failCount = 0;
        let failedParkings = [];
        let totalWithImages = 0;

        for (let i = 0; i < markerData.length; i++) {
          const marker = markerData[i];
          if (marker.imageUrl) {
            totalWithImages++;
            try {
              const res = await fetch(marker.imageUrl);
              if (!res.ok) throw new Error(`×¡×˜×˜×•×¡ ${res.status}`);
              const blob = await res.blob();
              const filename = `image_${i + 1}_${extractFileName(marker.imageUrl)}`;
              zip.file(filename, blob);
              successCount++;
              statusDiv.innerText = `ğŸ“¦ ×”×•×¡×¤×ª×™ ${successCount} ×ª××•× ×•×ª ×œ-ZIP...`;
            } catch (imgErr) {
              failCount++;
              failedParkings.push(marker.name || `×—× ×™×•×Ÿ ${i + 1}`);
              console.warn("×‘×¢×™×” ×‘×ª××•× ×”:", marker.imageUrl, imgErr);
            }
          }
        }

        if (successCount === 0) {
          statusDiv.innerText = "âŒ ×œ× × ××¦××• ×ª××•× ×•×ª ×ª×§×™× ×•×ª ×œ×”×•×¨×“×”.";
          return;
        }

        statusDiv.innerText = "ğŸ“¦ ×™×•×¦×¨ ××ª ×§×•×‘×¥ ×”-ZIP...";
        const content = await zip.generateAsync({ type: "blob" });

        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "parking_images_backup.zip";
        a.click();

        let resultMsg = `âœ… ×”×•×¨×“×” ×”×•×©×œ××” (${successCount} ××ª×•×š ${totalWithImages} ×ª××•× ×•×ª)\n`;
        if (failCount > 0) {
          resultMsg += `âš ï¸ ×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ×ª××•× ×•×ª ×©×œ:\n- ${failedParkings.join("\n- ")}`;
        }
        statusDiv.innerText = resultMsg;

      } catch (err) {
        console.error(err);
        statusDiv.innerText = "âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥ ××• ×‘×”×•×¨×“×”";
      }
    }

    function extractFileName(url) {
      return url.split('/').pop().split('?')[0];
    }
  </script>
</body>
</html>
