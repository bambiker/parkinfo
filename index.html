<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>מידע על חניות וחניונים בישראל</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            direction: rtl;
            text-align: right;
            padding: 10px;
        }
        #map { height: 500px; width: 100%; margin-top: 10px; }
        #controls { margin-bottom: 10px; }
        #colorDescription { font-size: 0.9em; margin-top: 5px; }
        #markerCount { font-weight: bold; margin-top: 5px; }
        #imageModal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        #imageModal img {
            display: block;
            margin: 50px auto;
            max-width: 90%;
            max-height: 90%;
            cursor: zoom-in;
        }
        #imageModal .close {
            position: absolute;
            top: 20px; left: 30px;
            font-size: 40px;
            font-weight: bold;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>

<h2>מידע על חניות וחניונים בישראל</h2>

<div id="controls">
    <label for="searchBox">חפש מיקום:</label>
    <input type="text" id="searchBox" placeholder="לדוג' תל אביב" />
    <button onclick="searchLocation()">חפש</button>
    <br></div>

<div id="map"></div>

<div id="imageModal">
    <span class="close" onclick="document.getElementById('imageModal').style.display='none'">&times;</span>
    <img id="modalImage" src="" alt="תמונה מוגדלת">
</div>

<div id="controls">

<br>

    <label for="markerColor">בחר צבע סימון:</label>
    <select id="markerColor">
        <option value="green">ירוק</option>
        <option value="blue">כחול</option>
        <option value="red">אדום</option>
        <option value="gold">אפור</option>
        <option value="yellow">צהוב</option>
        <option value="white">לבן</option>
        <option value="purple">סגול</option>
        <option value="orange">כתום</option>
    </select>
    <br>
    <label for="markerText">הוסף הערה:</label>
    <input type="text" id="markerText" placeholder="כתוב משהו..." /> <br>

    <label for="markerImage">צרף תמונה:</label>
    <input type="file" id="markerImage" accept="image/*" capture="environment" onchange="previewImage(event)" /><br>
    <br><br>
    <div id="markerCount">סימונים: 0</div>
    
    <button onclick="downloadMarkers()">הורד קובץ</button><br>
    טען קובץ
    <input type="file" id="uploadFile" accept=".json" onchange="uploadMarkers(event)" /><br>
</div>

<script>
let map;
let markers = [];
let currentLatLng = null;
let currentImage = null; // Store the current image for adding to markers

function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            currentImage = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function getIcon(color) {
    return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
}

function colorDescription(color) {
    const desc = {
        green: "חניון חינמי",
        blue: "חניון בתשלום",
        red: "אזור אסור לחניה",
        gold: "רחוב חניה עם קו אפור",
        yellow: "בתשלום ביום, חינם בלילה",
        white: "בתשלום ביום, בלילה לתושבים בלבד",
        purple: "שימוש מותאם אישית",
        orange: "שימוש מותאם אישית"
    };
    return desc[color] || "לא ידוע";
}

function addMarker(lat, lng, color, note, imageBase64 = null) {
    const marker = L.marker([lat, lng], {
        icon: getIcon(color),
        draggable: true
    }).addTo(map);

    const dateTime = new Date().toISOString();

    let popupHTML = `<b>${note}</b><br>קו: ${colorDescription(color)}<br>מיקום: ${lat.toFixed(5)}, ${lng.toFixed(5)}<br>תאריך: ${dateTime}`;
    if (imageBase64) {
        popupHTML += `<br><img src="${imageBase64}" style="max-width:100px; cursor:pointer;" onclick="showImageModal('${imageBase64}')">`;
    }

    // Add Waze navigation link
    const wazeUrl = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
    popupHTML += `<br><a href="${wazeUrl}" target="_blank">נווט עם Waze</a>`;

    marker.bindPopup(popupHTML);

    marker.on("contextmenu", () => {
        map.removeLayer(marker);
        markers = markers.filter(m => m.marker !== marker);
        updateMarkerCount();
    });

    markers.push({ marker, data: { lat, lng, color, note, imageBase64, dateTime } });
    updateMarkerCount();

    // Clear the input fields after adding the marker
    document.getElementById("markerText").value = "";
    document.getElementById("markerImage").value = "";
}

function updateMarkerCount() {
    document.getElementById("markerCount").innerText = `סימונים: ${markers.length}`;
}

function clearMarkers() {
    markers.forEach(m => map.removeLayer(m.marker));
    markers = [];
    updateMarkerCount();
}

function downloadMarkers() {
    const data = markers.map(m => {
        const latlng = m.marker.getLatLng();
        return { lat: latlng.lat, lng: latlng.lng, color: m.data.color, note: m.data.note, imageBase64: m.data.imageBase64 || null, dateTime: m.data.dateTime };
    });
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "markers.json";
    a.click();
    URL.revokeObjectURL(url);
}

function uploadMarkers(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            clearMarkers();
            data.forEach(d => addMarker(d.lat, d.lng, d.color, d.note, d.imageBase64));
        } catch (err) {
            alert("הקובץ לא תקין");
        }
    };
    reader.readAsText(file);
}

function showImageModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    modalImg.src = imageSrc;
    modal.style.display = 'block';
}

function searchLocation() {
    const query = document.getElementById("searchBox").value;
    if (!query) return;
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            if (data && data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                map.setView([lat, lon], 17);
                L.circle([lat, lon], {
                    color: 'blue', fillColor: '#30f', fillOpacity: 0.5, radius: 10
                }).addTo(map);
            } else {
                alert("מיקום לא נמצא");
            }
        });
}

function startMapAtUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            currentLatLng = { lat, lng };
            map = L.map('map').setView([lat, lng], 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            L.circle([lat, lng], {
                color: 'blue', fillColor: '#30f', fillOpacity: 0.5, radius: 10
            }).addTo(map);

            map.on("click", function(e) {
                const latlng = e.latlng;
                const color = document.getElementById("markerColor").value;
                const note = document.getElementById("markerText").value;
                addMarker(latlng.lat, latlng.lng, color, note, currentImage);
            });
        }, fallbackMap);
    } else {
        fallbackMap();
    }
}

function fallbackMap() {
    map = L.map('map').setView([32.075, 34.774], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    map.on("click", function(e) {
        const latlng = e.latlng;
        const color = document.getElementById("markerColor").value;
        const note = document.getElementById("markerText").value;
        addMarker(latlng.lat, latlng.lng, color, note, currentImage);
    });
}

startMapAtUserLocation();
</script>

</body>
</html>
