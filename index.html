<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Map with Markers & Photos</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        #map { height: 500px; width: 100%; }
        #controls { margin-bottom: 10px; }
        #colorDescription { font-size: 0.9em; margin-top: 5px; }

        /* Modal Styles */
        #imageModal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        #imageModal img {
            display: block;
            margin: 50px auto;
            max-width: 90%;
            max-height: 90%;
            cursor: zoom-in;
        }
        #imageModal .close {
            position: absolute;
            top: 20px; right: 30px;
            font-size: 40px;
            font-weight: bold;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>

<h2>Click on the Map to Add Custom Markers with Photos</h2>

<div id="controls">
    <label for="markerColor">Choose Marker Color:</label>
    <select id="markerColor">
        <option value="green">Green</option>
        <option value="blue">Blue</option>
        <option value="red">Red</option>
        <option value="gold">Gold</option>
        <option value="yellow">Yellow</option>
        <option value="white">White</option>
        <option value="purple">Purple</option>
        <option value="orange">Orange</option>
    </select>

    <label for="markerText">Enter Note:</label>
    <input type="text" id="markerText" placeholder="Write something..." />

    <label for="markerImage">Attach Photo:</label>
    <input type="file" id="markerImage" accept="image/*" capture="environment" />

    <button onclick="clearMarkers()">Clear Markers</button>
    <button onclick="downloadMarkers()">Download Markers</button>
    <input type="file" id="uploadFile" accept=".json" onchange="uploadMarkers(event)" />

    <div id="colorDescription">
        <ul>
            <li><span style="color:green">Green</span>: Free parking lot</li>
            <li><span style="color:blue">Blue</span>: Paid parking lot</li>
            <li><span style="color:red">Red</span>: No parking zone</li>
            <li><span style="color:goldenrod">Gold</span>: Grey parking street</li>
            <li><span style="color:yellow">Yellow</span>: Pay at day, free at night</li>
            <li><span style="color:gray">White</span>: Pay at day, residents only at night</li>
        </ul>
    </div>
</div>

<div id="map"></div>

<!-- Modal for zoomable image -->
<div id="imageModal">
    <span class="close" onclick="document.getElementById('imageModal').style.display='none'">&times;</span>
    <img id="modalImage" src="" alt="Zoomed Photo">
</div>

<script>
    let map;
    let markers = [];

    function getIcon(color) {
        return L.icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    function colorDescription(color) {
        const desc = {
            green: "Free parking lot",
            blue: "Paid parking lot",
            red: "No parking zone",
            gold: "Grey parking street",
            yellow: "Pay at day, free at night",
            white: "Pay at day, residents only at night",
            purple: "Custom use",
            orange: "Custom use"
        };
        return desc[color] || "Unknown";
    }

    function addMarker(lat, lng, color, note, imageBase64 = null) {
        const marker = L.marker([lat, lng], {
            icon: getIcon(color),
            draggable: true
        }).addTo(map);

        const imageId = 'img-' + Date.now();

        let popupHTML = `<b>${note}</b><br>Lat: ${lat.toFixed(5)}<br>Lng: ${lng.toFixed(5)}<br><i>${colorDescription(color)}</i>`;
        if (imageBase64) {
            popupHTML += `<br><img src="${imageBase64}" id="${imageId}" style="max-width:100px; cursor:pointer;" onclick="showImageModal('${imageBase64}')">`;
        }

        marker.bindPopup(popupHTML);

        marker.on("contextmenu", () => {
            map.removeLayer(marker);
            markers = markers.filter(m => m.marker !== marker);
        });

        markers.push({ marker, data: { lat, lng, color, note, imageBase64 } });
    }

    function onMapClick(e) {
        const color = document.getElementById("markerColor").value;
        const note = document.getElementById("markerText").value || "No note";
        const fileInput = document.getElementById("markerImage");
        const file = fileInput.files[0];

        if (file && file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                const img = new Image();
                img.onload = function() {
                    const maxDim = 400;
                    const scale = Math.min(maxDim / img.width, maxDim / img.height, 1);
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const resizedBase64 = canvas.toDataURL("image/jpeg", 0.7);
                    addMarker(e.latlng.lat, e.latlng.lng, color, note, resizedBase64);
                    fileInput.value = '';
                };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            addMarker(e.latlng.lat, e.latlng.lng, color, note);
        }
    }

    function clearMarkers() {
        markers.forEach(m => map.removeLayer(m.marker));
        markers = [];
    }

    function downloadMarkers() {
        const data = markers.map(m => {
            const latlng = m.marker.getLatLng();
            return {
                lat: latlng.lat,
                lng: latlng.lng,
                color: m.data.color,
                note: m.data.note,
                imageBase64: m.data.imageBase64 || null
            };
        });
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "markers.json";
        a.click();
        URL.revokeObjectURL(url);
    }

    function uploadMarkers(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                clearMarkers();
                data.forEach(d => addMarker(d.lat, d.lng, d.color, d.note, d.imageBase64));
            } catch (err) {
                alert("Invalid JSON file.");
            }
        };
        reader.readAsText(file);
    }

    function showImageModal(imageSrc) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        modalImg.src = imageSrc;
        modal.style.display = 'block';
    }

    function startMapAtUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                map = L.map('map').setView([lat, lng], 17);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);

                // Show circle (not marker) at user's location
                L.circle([lat, lng], {
                    color: 'blue',
                    fillColor: '#30f',
                    fillOpacity: 0.5,
                    radius: 10 // 10 meters radius
                }).addTo(map);

                map.on("click", onMapClick);
            }, function() {
                fallbackMap();
            });
        } else {
            fallbackMap();
        }
    }

    function fallbackMap() {
        map = L.map('map').setView([32.075, 34.774], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        map.on("click", onMapClick);
    }

    // Init map
    startMapAtUserLocation();
</script>

</body>
</html>
