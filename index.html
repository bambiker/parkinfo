<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>××™×“×¢ ×¢×œ ×—× ×™×•×ª ×•×—× ×™×•× ×™× ×‘×™×©×¨××œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            direction: rtl;
            text-align: right;
            padding: 10px;
        }
        #map { height: 500px; width: 100%; margin-top: 10px; }
        #controls { margin-bottom: 10px; }
        #colorDescription { font-size: 0.9em; margin-top: 5px; }
        #markerCount { font-weight: bold; margin-top: 5px; }
        #imageModal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        #imageModal img {
            display: block;
            margin: 50px auto;
            max-width: 90%;
            max-height: 90%;
            cursor: zoom-in;
        }
        #imageModal .close {
            position: absolute;
            top: 20px; left: 30px;
            font-size: 40px;
            font-weight: bold;
            color: white;
            cursor: pointer;
        }

    </style>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-591SDPD6H2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-591SDPD6H2');
</script>
</head>
<body>

<header style="background-color:#f5f5f5; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px;">
    <h1 style="margin: 0; font-size: 1.8em; color: #333;">ğŸ…¿ï¸ ××™×“×¢ ×¢×œ ×—× ×™×•×ª ×•×—× ×™×•× ×™× ×‘×™×©×¨××œ</h1>
    <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
        <input type="text" id="searchBox" placeholder="×œ×“×•×’××”: ×ª×œ ××‘×™×‘" 
               style="flex: 1; min-width: 180px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em;" />
        <button onclick="searchLocation()" 
                style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">
            ğŸ” ×—×¤×©
        </button>
    </div>
</header>

<div id="map"></div>

<div id="imageModal">
    <span class="close" onclick="document.getElementById('imageModal').style.display='none'">&times;</span>
    <img id="modalImage" src="" alt="×ª××•× ×” ××•×’×“×œ×ª">
</div>

<div id="controls">
    <br>
    <label><input type="checkbox" id="enableMarkers"> ××¤×©×¨ ×”×•×¡×¤×ª ×¡×™××•× ×™×</label><br><br>

    <label for="markerColor">×‘×—×¨ ×¦×‘×¢ ×¡×™××•×Ÿ:</label>
    <select id="markerColor" style="margin: 10px; font-weight: bold;" >
        <option value="grey">××¤×•×¨ - ×—× ×™×” ×—×•×¤×©×™×ª ×‘×¨×—×•×‘</option>
        <option value="blue">×›×—×•×œ - ×—× ×™×ª ×¨×—×•×‘ ×‘×ª×©×œ×•× ×‘××”×œ×š ×”×™×•× ×•×—×•×¤×©×™×ª ×‘×œ×™×œ×”</option>
        <option value="orange">×›×ª×•× - ×—× ×™×ª ×¨×—×•×‘ ×‘×ª×©×œ×•× ×‘××”×œ×š ×”×™×•× ×•×œ×“×™×™×¨×™× ×‘×œ×™×œ×”</option>
        <option value="red">××“×•× - ×—× ×™×” ××¡×•×¨×”</option>
        <option value="black"> ×©×—×•×¨ - ×—× ×™×•×Ÿ ×‘×—×™× ×</option>
        <option value="violet"> ×¡×’×•×œ - ×—× ×™×•×Ÿ ×‘×ª×©×œ×•×</option>
        <option value="green">×™×¨×•×§ - ×—× ×™×” ××™×•×—×“×ª</option>
        <option value="yellow">×¦×”×•×‘</option>
    </select><br>

    <label for="markerText">×”×•×¡×£ ×”×¢×¨×”:</label>
    <input type="text" id="markerText" placeholder="×›×ª×•×‘ ××©×”×•..." /><br>
    <label for="markerHourly"> ××—×™×¨ ×©×¢×ª×™:</label>
    <input type="text" id="markerHourly" placeholder="" /><br>
    <label for="markerDaily">××—×™×¨ ×™×•××™:</label>
    <input type="text" id="markerDaily" placeholder="" /><br>
    <label for="markerImage">×¦×¨×£ ×ª××•× ×”:</label>
    <input type="file" id="markerImage" accept="image/*" capture="environment" /><br><br>

    <div id="markerCount">×¡×™××•× ×™×: 0</div>

    <button onclick="downloadMarkers()">×’×™×‘×•×™ ×”×¡×™××•× ×™×</button><br>
    ×˜×¢×Ÿ ×§×•×‘×¥ ×¡×™××•× ×™×:
    <input type="file" id="uploadFile" accept=".json" onchange="uploadMarkers(event)" /><br>
</div>

<div >
<br>
<a href="https://docs.google.com/forms/d/e/1FAIpQLScJ_xLvKoVq3hQDqrJ06KrMifxZ-lqTE6dZ4zDnANBZC53Bug/viewform?usp=sharing&ouid=111833292316340372069" target="blank">×¦×•×¨ ×§×©×¨</a><br>
<a href="terms.html" target="_blank">×ª× ××™ ×©×™××•×© ×‘××ª×¨</a>.<br>
</div>

<script>
const IMGUR_CLIENT_ID = "1531d493c436bc9";
let map;
let markers = [];
let currentLatLng = null;

function getIcon(color) {
    return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
}

function colorDescription(color) {
    const desc = {
        grey: "××¤×•×¨ - ×—× ×™×” ×—×•×¤×©×™×ª ×‘×¨×—×•×‘",
        blue: "×›×—×•×œ - ×—× ×™×ª ×¨×—×•×‘ ×‘×ª×©×œ×•× ×‘××”×œ×š ×”×™×•× ×•×—×•×¤×©×™×ª ×‘×œ×™×œ×”",
        orange: "×›×ª×•× - ×—× ×™×ª ×¨×—×•×‘ ×‘×ª×©×œ×•× ×‘××”×œ×š ×”×™×•× ×•×œ×“×™×™×¨×™× ×‘×œ×™×œ×”",
        red: "××“×•× - ×—× ×™×” ××¡×•×¨×”",
        black: "×©×—×•×¨ - ×—× ×™×•×Ÿ ×‘×—×™× ×",
        violet: " ×¡×’×•×œ - ×—× ×™×•×Ÿ ×‘×ª×©×œ×•×",
        green: "×™×¨×•×§ - ×—× ×™×” ××™×•×—×“×ª",
        yellow: "×¦×”×•×‘"
    };
    return desc[color] || "×œ× ×™×“×•×¢";
}


function addMarker(lat, lng, color, note, hourly, daily, imageUrl = null) {
    let svgText = '×—× ×™×•×Ÿ';  
    if (color==='black')
	{svgText = '×—×™× ×';}
    else 
	{svgText = hourly;}
	
    let circleSVGString = '<svg version="1.2" baseProfile="tiny" xmlns="http://www.w3.org/2000/svg" width="250" height="250"><circle cx="125" cy="125" r="100" fill="'+color+'"/><text x="50%" y="50%" text-anchor="middle" fill="white" font-size="100px" font-family="Arial" dy=".3em">'+svgText+'</text></svg>'
    let iconURL = "data:image/svg+xml," + encodeURIComponent(circleSVGString);
   
    var circleIcon = L.icon({
        iconUrl: iconURL,
        iconSize: [40, 40]
    });
    const marker = L.marker([lat, lng], {
        icon: circleIcon,
        draggable: true
    }).addTo(map);


    const dateTime = new Date().toISOString();

    let popupHTML = `<div style="direction: rtl; text-align: right;"><b>${note}</b><br>${colorDescription(color)}<br>××™×§×•×: ${lat.toFixed(5)}, ${lng.toFixed(5)}<br>×ª××¨×™×š: ${dateTime}`;
    if (imageUrl) {
        popupHTML += `<br><img src="${imageUrl}" style="max-width:100px; cursor:pointer;" onclick="showImageModal('${imageUrl}')">`;
    }
    if (hourly) {
        popupHTML += `<br> ××—×™×¨ ×œ×©×¢×” ${hourly} `;
    }
    if (daily) {
        popupHTML += `<br> ××—×™×¨ ×œ×™×××” ${daily} `;
    }
    const wazeUrl = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
    popupHTML += `<br><a href="${wazeUrl}" target="_blank">× ×•×•×˜ ×¢× Waze</a></div>`;

    marker.bindPopup(popupHTML);

    marker.on("contextmenu", () => {
        map.removeLayer(marker);
        markers = markers.filter(m => m.marker !== marker);
        updateMarkerCount();
    });

    markers.push({ marker, data: { lat, lng, color, note, hourly, daily, imageUrl, dateTime } });
    updateMarkerCount();

    // Clear inputs
    document.getElementById("markerText").value = "";
    document.getElementById("markerHourly").value = "";
    document.getElementById("markerDaily").value = "";	
    document.getElementById("markerImage").value = "";
}

function updateMarkerCount() {
    document.getElementById("markerCount").innerText = `×¡×™××•× ×™×: ${markers.length}`;
}

function clearMarkers() {
    markers.forEach(m => map.removeLayer(m.marker));
    markers = [];
    updateMarkerCount();
}

function downloadMarkers() {
    const data = markers.map(m => {
        const latlng = m.marker.getLatLng();
        return { lat: latlng.lat, lng: latlng.lng, color: m.data.color, note: m.data.note, hourly: m.data.hourly, daily: m.data.daily, imageUrl: m.data.imageUrl || null, dateTime: m.data.dateTime };
    });
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "markers.json";
    a.click();
    URL.revokeObjectURL(url);
}

function uploadMarkers(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            clearMarkers();
            data.forEach(d => addMarker(d.lat, d.lng, d.color, d.note, d.hourly, d.daily, d.imageUrl));
        } catch (err) {
            alert("×”×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ");
        }
    };
    reader.readAsText(file);
}

function showImageModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    modalImg.src = imageSrc;
    modal.style.display = 'block';
}

function searchLocation() {
    const query = document.getElementById("searchBox").value;
    if (!query) return;
    ch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            if (data && data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                map.setView([lat, lon], 17);
                L.circle([lat, lon], {
                    color: 'blue', fillColor: '#30f', fillOpacity: 0.5, radius: 10
                }).addTo(map);
            } else {
                alert("××™×§×•× ×œ× × ××¦×");
            }
        });
}

function uploadToImgur(file, callback) {
    const formData = new FormData();
    formData.append("image", file);
    fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
            Authorization: `Client-ID ${IMGUR_CLIENT_ID}`
        },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            callback(data.data.link);
        } else {
            alert("×©×’×™××” ×‘×”×¢×œ××ª ×”×ª××•× ×”");
            callback(null);
        }
    })
    .catch(() => {
        alert("×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ-Imgur");
        callback(null);
    });
}

function startMapAtUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            currentLatLng = { lat, lng };
            map = L.map('map').setView([lat, lng], 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            L.circle([lat, lng], {
                color: 'blue', fillColor: '#30f', fillOpacity: 0.5, radius: 10
            }).addTo(map);
			map.attributionControl.setPrefix('Leaflet')

            map.on("click", function(e) {
                if (!document.getElementById("enableMarkers").checked) return;

                const latlng = e.latlng;
                const color = document.getElementById("markerColor").value;
                const note = document.getElementById("markerText").value;
                const hourly = document.getElementById("markerHourly").value;
                const daily = document.getElementById("markerDaily").value;
                const file = document.getElementById("markerImage").files[0];

                if (file) {
                    uploadToImgur(file, (imgUrl) => {
                        addMarker(latlng.lat, latlng.lng, color, note, hourly, daily, imgUrl);
                    });
                } else {
                    addMarker(latlng.lat, latlng.lng, color, note, hourly, daily, null);
                }
            });
		fetch('marker.json')  // onload start
		  .then(res => res.json())
		  .then(data => {
		      if (Array.isArray(data)) {
		          data.forEach(d => addMarker(d.lat, d.lng, d.color, d.note, d.hourly, d.daily, d.imageUrl));
		      } else {
		          console.error("Invalid marker data");
		      }
		  })
		  .catch(err => {
		      console.warn("No auto-load file found or invalid JSON:", err);
		  });
		    		
        }, fallbackMap);   // onload end

    } else {
        fallbackMap();
    }
}

function fallbackMap() {
    map = L.map('map').setView([32.075, 34.774], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    map.on("click", function(e) {
        if (!document.getElementById("enableMarkers").checked) return;

        const latlng = e.latlng;
        const color = document.getElementById("markerColor").value;
        const note = document.getElementById("markerText").value;
        const hourly = document.getElementById("markerHourly").value;
        const daily = document.getElementById("markerDaily").value;
        const file = document.getElementById("markerImage").files[0];

        if (file) {
            uploadToImgur(file, (imgUrl) => {
                addMarker(latlng.lat, latlng.lng, color, note, hourly, daily, imgUrl);
            });
        } else {
            addMarker(latlng.lat, latlng.lng, color, note, hourly, daily, null);
        }
    });
}

startMapAtUserLocation();
	
</script>

</body>
</html>
